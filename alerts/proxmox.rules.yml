groups:
  - name: proxmox.rules
    rules:
      # üî¥ –í—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ CPU –Ω–∞ —É–∑–ª–µ
      - alert: ProxmoxNodeHighCpuUsage
        expr: proxmox_node_cpu_usage_percent > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "–í—ã—Å–æ–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ CPU –Ω–∞ Proxmox-—É–∑–ª–µ (–≤—ã—à–µ 80%)"
          description: "–£–∑–µ–ª {{ $labels.node }} –∏–º–µ–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É CPU {{ $value | printf \"%.2f\" }}% –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç."

      # üî¥ –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
      - alert: ProxmoxNodeHighMemoryUsage
        expr: |
          (proxmox_node_memory_usage_bytes / (
            proxmox_node_memory_usage_bytes + 
            (avg_over_time(proxmox_node_memory_usage_bytes[5m]) > 0)
          )) * 100 > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "–í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –Ω–∞ Proxmox-—É–∑–ª–µ"
          description: "–£–∑–µ–ª {{ $labels.node }} –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–æ–ª–µ–µ 85% RAM. –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: {{ $value | printf \"%.2f\" }}%."

      # üî¥ –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
      - alert: ProxmoxVmDown
        expr: proxmox_vm_status == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
          description: "VM {{ $labels.name }} (VMID: {{ $labels.vmid }}) –Ω–∞ —É–∑–ª–µ {{ $labels.node }} –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞."

      # üü° –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–∞—Å—Ç–æ
      - alert: ProxmoxVmFrequentRestarts
        expr: changes(proxmox_vm_status[1h]) > 3
        for: 1s
        labels:
          severity: warning
        annotations:
          summary: "–ß–∞—Å—Ç—ã–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏ –í–ú"
          description: "–í–ú {{ $labels.name }} (VMID: {{ $labels.vmid }}) –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å –±–æ–ª–µ–µ 3 —Ä–∞–∑ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å."

      # üî¥ –£–∑–µ–ª –∏—Å—á–µ–∑ –∏–∑ –º–µ—Ç—Ä–∏–∫ (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
      - alert: ProxmoxNodeMissingMetrics
        expr: |
          absent(up{job="proxmox"} or proxmox_node_cpu_usage_percent offset 5m)
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "–ü—Ä–æ–ø–∞–ª–∏ –º–µ—Ç—Ä–∏–∫–∏ —Å Proxmox-—É–∑–ª–∞"
          description: "–ú–µ—Ç—Ä–∏–∫–∏ —Å —É–∑–ª–∞ {{ $labels.node }} –Ω–µ –ø–æ—Å—Ç—É–ø–∞—é—Ç –±–æ–ª–µ–µ 2 –º–∏–Ω—É—Ç. –í–æ–∑–º–æ–∂–Ω–æ, —É–∑–µ–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."

      # üî¥ –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —É–∑–ª–µ —Ä–∞—Å—Ç—ë—Ç —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ
      - alert: ProxmoxNodeCpuSpiking
        expr: |
          rate(proxmox_node_cpu_usage_percent[5m]) > 10
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "–†–µ–∑–∫–∏–π —Ä–æ—Å—Ç CPU –Ω–∞ —É–∑–ª–µ"
          description: "–ó–∞–≥—Ä—É–∑–∫–∞ CPU –Ω–∞ —É–∑–ª–µ {{ $labels.node }} —Ä–∞—Å—Ç—ë—Ç –±—ã—Å—Ç—Ä–µ–µ 10% –≤ –º–∏–Ω—É—Ç—É. –¢–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: {{ $value | printf \"%.2f\" }}%/–º–∏–Ω."